<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="3D visualization of RFC documents and their relationships." />
  <link rel="preload" href="https://raw.githubusercontent.com/h-ssiqueira/Architecture_Coding_Standards/refs/heads/data/graph_data.json" as="fetch" crossorigin>
  <link rel="preload" href="https://unpkg.com/3d-force-graph" as="fetch" crossorigin>

  <title>RFCs</title>
  <style>
    body { margin: 0; background-color: #101020; }
    canvas { display: block; }
    .search-container {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
    }

    #search {
      padding: 6px;
      margin-right: 4px;
    }

    button {
      padding: 6px;
    }

    .toggle {
      display: inline-flex;
      align-items: center;
      margin-left: 8px;
      color: #ddd;
      font-size: 13px;
    }

    .switch {
      position: relative;
      width: 42px;
      height: 22px;
      margin-left: 8px;
    }

    .switch input { display: none; }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #444;
      border-radius: 22px;
      transition: .2s;
    }

    .slider:before {
      content: "";
      position: absolute;
      height: 18px; width: 18px;
      left: 2px; top: 2px;
      background: #fff;
      border-radius: 50%;
      transition: .2s;
    }

    input:checked + .slider {
      background-color: #2a8fbd;
    }

    input:checked + .slider:before {
      transform: translateX(20px);
    }
  </style>
  <link rel="icon" href="https://www.rfc-editor.org/wp-content/uploads/favicon-1.ico" sizes="32x32">
  <link rel="icon" href="https://www.rfc-editor.org/wp-content/uploads/favicon-1.ico" sizes="192x192">
</head>
<body>
  <div class="search-container">
    <input id="search" placeholder="Enter RFC code..." />
    <button onclick="findNode()">Find</button>

    <label class="toggle" title="Enable node/link hover highlighting">
      Hover animation
      <span class="switch">
        <input id="hover-toggle" type="checkbox" />
        <span class="slider"></span>
      </span>
    </label>
  </div>

  <div id="3d-graph"></div>

  <script src="https://unpkg.com/3d-force-graph"></script>

  <script>
    let graph;
    const highlightNodes = new Set();
    const highlightLinks = new Set();
    let hoverNode = null;
    let hoverEnabled = false;
    const hoverToggle = document.getElementById && document.getElementById('hover-toggle');
    if (hoverToggle) {
      hoverToggle.checked = hoverEnabled;
      hoverToggle.addEventListener('change', (e) => {
        hoverEnabled = e.target.checked;
        if (!hoverEnabled) {
          highlightNodes.clear();
          highlightLinks.clear();
          hoverNode = null;
          if (graph) graph.refresh();
        }
      });
    }

    fetch('https://raw.githubusercontent.com/h-ssiqueira/Architecture_Coding_Standards/refs/heads/data/graph_data.json')
      .then(res => res.json())
      .then(raw => {
        const nodeById = {};
        raw.nodes.forEach(node => { nodeById[node.id] = node; });

        const data = { nodes: raw.nodes, links: raw.edges };

        data.links.forEach(link => {
          const a = nodeById[link.source];
          const b = nodeById[link.target];
          if (!a || !b) return;

          !a.neighbors && (a.neighbors = []);
          !b.neighbors && (b.neighbors = []);
          a.neighbors.push(b);
          b.neighbors.push(a);

          !a.links && (a.links = []);
          !b.links && (b.links = []);
          a.links.push(link);
          b.links.push(link);
        });

        graph = ForceGraph3D({forceEngine: 'ngraph'})(document.getElementById('3d-graph'))
          .graphData(data)
          .nodeLabel(node => node._label || (`${node.id} - ${node.title}\nDate: ${node.date}\nStatus: ${node.status}`))
          .nodeColor(node => highlightNodes.has(node) ? node === hoverNode ? 'rgb(255,0,0,1)' : 'rgba(255,160,0,0.8)' : (node.color || '#888'))
          .nodeVal(node => Math.min(node.size || 5, 20))
          .nodeResolution(16)
          .linkDirectionalArrowLength(link => highlightLinks.has(link) ? 3 : 0)
          .linkDirectionalParticles(link => highlightLinks.has(link) ? 2 : 0)
          .linkColor(() => '#ccc')
          .linkResolution(8)
          .backgroundColor('#101020')
          .onNodeClick(node => {
            window.open(`https://www.rfc-editor.org/rfc/${node.id.match(/RFC\\s*\\d+/i)[0].replace(/\\s+/g, '').toLowerCase()}`, '_blank', 'noopener');
          })
          .linkWidth(link => highlightLinks.has(link) ? 4 : 1)
          .linkDirectionalParticleWidth(4);

        graph.onNodeHover(node => {
          if (!hoverEnabled) {
            if (hoverNode || highlightNodes.size || highlightLinks.size) {
              highlightNodes.clear();
              highlightLinks.clear();
              hoverNode = null;
              graph.refresh();
            }
            return;
          }

          if ((!node && !highlightNodes.size) || (node && hoverNode === node)) return;

          highlightNodes.clear();
          highlightLinks.clear();
          if (node) {
            highlightNodes.add(node);
            (node.neighbors || []).forEach(neighbor => highlightNodes.add(neighbor));
            (node.links || []).forEach(l => highlightLinks.add(l));
          }

          hoverNode = node || null;
          graph.refresh();
        });

        graph.onLinkHover(link => {
          if (!hoverEnabled) {
            if (highlightNodes.size || highlightLinks.size) {
              highlightNodes.clear();
              highlightLinks.clear();
              graph.refresh();
            }
            return;
          }

          highlightNodes.clear();
          highlightLinks.clear();

          if (link) {
            highlightLinks.add(link);
            highlightNodes.add(link.source);
            highlightNodes.add(link.target);
          }

          graph.refresh();
        });

        graph.d3Force('charge').strength(-10);
        graph.d3VelocityDecay(0.2);

        setTimeout(() => {
          graph.d3Force('charge', null);
          graph.d3Force('link', null);
        }, 5000);
      })
      .catch(err => console.error('Failed to load graph data:', err));

    function findNode() {
      const query = document.getElementById('search').value.trim();
      if (!graph || !query) return;

      const node = graph.graphData().nodes.find(n =>
        n.id.startsWith('RFC\u00a0' + query)
      );
      if (node) {
        graph.cameraPosition(
          { x: node.x * 1.1, y: node.y * 1.1, z: node.z * 1.1 },
          node,
          500
        );
      } else {
        alert("Node not found.");
      }
    }

    document.getElementById('search').addEventListener('keydown', function(event) {
      if (event.key === 'Enter') {
        findNode();
      }
    });

    window.addEventListener('pagehide', () => {
      if (graph) {
        try {
          graph.renderer().dispose();
        } catch (e) {
          console.warn("Cleanup failed", e);
        }
      }
    });
  </script>
</body>
</html>
